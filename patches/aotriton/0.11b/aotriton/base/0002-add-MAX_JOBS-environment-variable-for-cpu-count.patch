From 3b4e17207cf4d4fe9f50672d0cbaae6624e2ab1a Mon Sep 17 00:00:00 2001
From: Mika Laitio <mika.laitio@amd.com>
Date: Fri, 7 Nov 2025 10:55:03 -0800
Subject: [PATCH 2/3] add MAX_JOBS environment variable for cpu count

MAX_JOBS can be used to limit the amount of CPU cores
used for building. Helps for not running out of memory
on systems where there is not enought memory.

Signed-off-by: Mika Laitio <mika.laitio@amd.com>
---
 v3src/CMakeLists.txt | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/v3src/CMakeLists.txt b/v3src/CMakeLists.txt
index d8c28a9..807737e 100644
--- a/v3src/CMakeLists.txt
+++ b/v3src/CMakeLists.txt
@@ -12,6 +12,17 @@ set(AOTRITON_KERNEL_STORAGE_V2_DIR "${AOTRITON_V2_BUILD_DIR}/aotriton.images")
 execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory "${AOTRITON_V2_BUILD_DIR}")
 execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory "${AOTRITON_KERNEL_STORAGE_V2_DIR}")
 
+if(DEFINED ENV{MAX_JOBS})
+  set(MAX_JOBS "$ENV{MAX_JOBS}")
+else()
+  cmake_host_system_information(RESULT MAX_JOBS QUERY NUMBER_OF_PHYSICAL_CORES)
+  if(MAX_JOBS LESS 2) # In case of failures.
+    set(MAX_JOBS 2)
+  endif()
+endif()
+
+set_property(GLOBAL PROPERTY JOB_POOLS MAX_JOB_CNT__HSACO=${MAX_JOBS})
+
 execute_process(COMMAND ${CMAKE_COMMAND}
   -E env VIRTUAL_ENV=${VENV_DIR}
   "${VENV_BIN_PYTHON}" -m v3python.gpu_targets
@@ -130,6 +141,7 @@ if(NOT AOTRITON_NOIMAGE_MODE)
       "--signature" "${SIG}"
       "--timeout" "${AOTRITON_GPU_BUILD_TIMEOUT}"
       DEPENDS aotriton_venv_triton
+      JOB_POOL MAX_JOB_CNT__HSACO
     )
     # DO NOT USE list(APPEND). It is quadratic growth
     file(APPEND "${AOTRITON_HSACO_RECORD}" "${HSACO}" "\n")
-- 
2.43.0

